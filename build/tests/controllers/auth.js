'use strict';

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _lab = require('lab');

var _lab2 = _interopRequireDefault(_lab);

var _server = require('../../server');

var _server2 = _interopRequireDefault(_server);

var _faker = require('faker');

var _faker2 = _interopRequireDefault(_faker);

var _data = require('../data');

var _data2 = _interopRequireDefault(_data);

var expect = _lab2['default'].assertions.expect;
var lab = _lab2['default'].script();

exports.lab = lab;
lab.experiment('AuthCtrl', function () {

  var oauthScope = 'test';
  var oauthCode = null;

  lab.before(function (done) {
    _data2['default'].sync().then(done, done);
  });

  lab.test('[logIn] returns the account and profile on success', function (done) {
    var options = {
      method: 'POST',
      url: '/login',
      headers: {
        'Authorization': 'Bearer ' + _data2['default'].fp.token.value
      },
      payload: {
        username: _data2['default'].tp.account.username,
        password: _data2['default'].tp.account.unencryptedPassword
      }
    };

    _server2['default'].inject(options, function (response) {
      var result = response.result;

      expect(response.statusCode).to.equal(200);
      expect(result.username).to.equal(_data2['default'].tp.account.username);
      expect(result.profile).to.not.be.undefined();

      done();
    });
  });

  lab.test('[logIn] returns 404 for invalid username', function (done) {
    var options = {
      method: 'POST',
      url: '/login',
      headers: {
        'Authorization': 'Bearer ' + _data2['default'].fp.token.value
      },
      payload: {
        username: '133744',
        password: _data2['default'].tp.account.unencryptedPassword
      }
    };

    _server2['default'].inject(options, function (response) {
      expect(response.statusCode).to.equal(404);
      done();
    });
  });

  lab.test('[logIn] returns 401 for invalid password', function (done) {
    var options = {
      method: 'POST',
      url: '/login',
      headers: {
        'Authorization': 'Bearer ' + _data2['default'].fp.token.value
      },
      payload: {
        username: _data2['default'].tp.account.username,
        password: '133744'
      }
    };

    _server2['default'].inject(options, function (response) {
      expect(response.statusCode).to.equal(401);
      done();
    });
  });

  lab.test('[authorize] returns an oauth code for exchange', function (done) {
    var options = {
      method: 'POST',
      url: '/oauth/authorize',
      headers: {
        'Authorization': 'Bearer ' + _data2['default'].fp.token.value
      },
      payload: {
        scope: oauthScope,
        clientId: _data2['default'].tp.client.id
      }
    };

    _server2['default'].inject(options, function (response) {
      var result = response.result;
      oauthCode = result.value;

      expect(response.statusCode).to.equal(200);
      expect(result.clientId).to.equal(_data2['default'].tp.client.id);
      expect(result.value).to.exist();

      done();
    });
  });

  lab.test('[exchangeCode] returns an error if the secret is invalid', function (done) {
    var options = {
      method: 'POST',
      url: '/oauth/exchange/code',
      headers: {
        'Authorization': 'Bearer ' + _data2['default'].fp.token.value
      },
      payload: {
        code: oauthCode,
        clientId: _data2['default'].tp.client.id,
        clientSecret: 'ItsNotASecretIfYouToldEverybody'
      }
    };

    _server2['default'].inject(options, function (response) {
      expect(response.statusCode).to.equal(400);
      done();
    });
  });

  lab.test('[exchangeCode] returns a bearer token if the code is valid', function (done) {
    var options = {
      method: 'POST',
      url: '/oauth/exchange/code',
      headers: {
        'Authorization': 'Bearer ' + _data2['default'].fp.token.value
      },
      payload: {
        code: oauthCode,
        clientId: _data2['default'].tp.client.id,
        clientSecret: _data2['default'].tp.client.secret
      }
    };

    _server2['default'].inject(options, function (response) {
      var result = response.result;

      expect(response.statusCode).to.equal(200);
      expect(result.scope).to.equal(oauthScope);
      expect(result.value).to.exist();

      done();
    });
  });

  lab.test('[exchangeCode] returns an error if the code is invalid', function (done) {
    var options = {
      method: 'POST',
      url: '/oauth/exchange/code',
      headers: {
        'Authorization': 'Bearer ' + _data2['default'].fp.token.value
      },
      payload: {
        code: '10240',
        clientId: _data2['default'].tp.client.id,
        clientSecret: _data2['default'].tp.client.secret
      }
    };

    _server2['default'].inject(options, function (response) {
      expect(response.statusCode).to.equal(404);
      done();
    });
  });

  lab.test('[exchangeCode] returns an error if the code has already been used', function (done) {
    var options = {
      method: 'POST',
      url: '/oauth/exchange/code',
      headers: {
        'Authorization': 'Bearer ' + _data2['default'].fp.token.value
      },
      payload: {
        code: oauthCode,
        clientId: _data2['default'].tp.client.id,
        clientSecret: _data2['default'].tp.client.secret
      }
    };

    _server2['default'].inject(options, function (response) {
      expect(response.statusCode).to.equal(400);
      done();
    });
  });

  lab.test('[exchangeCredentials] returns a bearer token for valid credentials', function (done) {
    var options = {
      method: 'POST',
      url: '/oauth/exchange/credentials',
      headers: {
        'Authorization': 'Bearer ' + _data2['default'].fp.token.value
      },
      payload: {
        username: _data2['default'].tp.account.username,
        password: _data2['default'].tp.account.unencryptedPassword
      }
    };

    _server2['default'].inject(options, function (response) {
      var result = response.result;

      expect(response.statusCode).to.equal(200);
      expect(result.value).to.exist();

      done();
    });
  });

  lab.test('[exchangeCredentials] returns 401 for invalid password', function (done) {
    var options = {
      method: 'POST',
      url: '/oauth/exchange/credentials',
      headers: {
        'Authorization': 'Bearer ' + _data2['default'].fp.token.value
      },
      payload: {
        username: _data2['default'].tp.account.username,
        password: '1337'
      }
    };

    _server2['default'].inject(options, function (response) {
      expect(response.statusCode).to.equal(401);
      done();
    });
  });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy90ZXN0cy9jb250cm9sbGVycy9hdXRoLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7O21CQUFnQixLQUFLOzs7O3NCQUNGLGNBQWM7Ozs7cUJBRWYsT0FBTzs7OztvQkFDUixTQUFTOzs7O0FBRTFCLElBQU0sTUFBTSxHQUFHLGlCQUFJLFVBQVUsQ0FBQyxNQUFNLENBQUM7QUFDOUIsSUFBTSxHQUFHLEdBQUcsaUJBQUksTUFBTSxFQUFFLENBQUM7OztBQUVoQyxHQUFHLENBQUMsVUFBVSxDQUFDLFVBQVUsRUFBRSxZQUFXOztBQUVwQyxNQUFJLFVBQVUsR0FBRyxNQUFNLENBQUM7QUFDeEIsTUFBSSxTQUFTLEdBQUcsSUFBSSxDQUFDOztBQUVyQixLQUFHLENBQUMsTUFBTSxDQUFDLFVBQUEsSUFBSSxFQUFJO0FBQ2pCLHNCQUFLLElBQUksRUFBRSxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUM7R0FDOUIsQ0FBQyxDQUFDOztBQUVILEtBQUcsQ0FBQyxJQUFJLENBQUMsb0RBQW9ELEVBQUUsVUFBUyxJQUFJLEVBQUU7QUFDNUUsUUFBTSxPQUFPLEdBQUc7QUFDZCxZQUFNLEVBQUUsTUFBTTtBQUNkLFNBQUcsRUFBRSxRQUFRO0FBQ2IsYUFBTyxFQUFFO0FBQ1AsdUJBQWUsY0FBWSxrQkFBSyxFQUFFLENBQUMsS0FBSyxDQUFDLEtBQUssQUFBRTtPQUNqRDtBQUNELGFBQU8sRUFBRTtBQUNQLGdCQUFRLEVBQUUsa0JBQUssRUFBRSxDQUFDLE9BQU8sQ0FBQyxRQUFRO0FBQ2xDLGdCQUFRLEVBQUUsa0JBQUssRUFBRSxDQUFDLE9BQU8sQ0FBQyxtQkFBbUI7T0FDOUM7S0FDRixDQUFDOztBQUVGLHdCQUFPLE1BQU0sQ0FBQyxPQUFPLEVBQUUsVUFBUyxRQUFRLEVBQUU7QUFDeEMsVUFBTSxNQUFNLEdBQUcsUUFBUSxDQUFDLE1BQU0sQ0FBQzs7QUFFL0IsWUFBTSxDQUFDLFFBQVEsQ0FBQyxV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TUFBTSxHQUFHLFFBQVEsQ0FBQyxNQUFNLENBQUM7O0FBRS9CLFlBQU0sQ0FBQyxRQUFRLENBQUMsVUFBVSxDQUFDLENBQUMsRUFBRSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztBQUMxQyxZQUFNLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUUsQ0FBQyxLQUFLLEVBQUUsQ0FBQzs7QUFFaEMsVUFBSSxFQUFFLENBQUM7S0FDUixDQUFDLENBQUM7R0FDSixDQUFDLENBQUM7O0FBRUgsS0FBRyxDQUFDLElBQUksQ0FBQyx3REFBd0QsRUFBRSxVQUFTLElBQUksRUFBRTtBQUNoRixRQUFNLE9BQU8sR0FBRztBQUNkLFlBQU0sRUFBRSxNQUFNO0FBQ2QsU0FBRyxFQUFFLDZCQUE2QjtBQUNsQyxhQUFPLEVBQUU7QUFDUCx1QkFBZSxjQUFZLGtCQUFLLEVBQUUsQ0FBQyxLQUFLLENBQUMsS0FBSyxBQUFFO09BQ2pEO0FBQ0QsYUFBTyxFQUFFO0FBQ1AsZ0JBQVEsRUFBRSxrQkFBSyxFQUFFLENBQUMsT0FBTyxDQUFDLFFBQVE7QUFDbEMsZ0JBQVEsRUFBRSxNQUFNO09BQ2pCO0tBQ0YsQ0FBQzs7QUFFRix3QkFBTyxNQUFNLENBQUMsT0FBTyxFQUFFLFVBQVMsUUFBUSxFQUFFO0FBQ3hDLFlBQU0sQ0FBQyxRQUFRLENBQUMsVUFBVSxDQUFDLENBQUMsRUFBRSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztBQUMxQyxVQUFJLEVBQUUsQ0FBQztLQUNSLENBQUMsQ0FBQztHQUNKLENBQUMsQ0FBQztDQUVKLENBQUMsQ0FBQyIsImZpbGUiOiJhdXRoLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IExhYiBmcm9tICdsYWInO1xuaW1wb3J0IHNlcnZlciBmcm9tICcuLi8uLi9zZXJ2ZXInO1xuXG5pbXBvcnQgZmFrZXIgZnJvbSAnZmFrZXInO1xuaW1wb3J0IGRhdGEgZnJvbSAnLi4vZGF0YSc7XG5cbmNvbnN0IGV4cGVjdCA9IExhYi5hc3NlcnRpb25zLmV4cGVjdDtcbmV4cG9ydCBjb25zdCBsYWIgPSBMYWIuc2NyaXB0KCk7XG5cbmxhYi5leHBlcmltZW50KCdBdXRoQ3RybCcsIGZ1bmN0aW9uKCkge1xuXG4gIGxldCBvYXV0aFNjb3BlID0gJ3Rlc3QnO1xuICBsZXQgb2F1dGhDb2RlID0gbnVsbDtcblxuICBsYWIuYmVmb3JlKGRvbmUgPT4ge1xuICAgIGRhdGEuc3luYygpLnRoZW4oZG9uZSwgZG9uZSk7XG4gIH0pO1xuXG4gIGxhYi50ZXN0KCdbbG9nSW5dIHJldHVybnMgdGhlIGFjY291bnQgYW5kIHByb2ZpbGUgb24gc3VjY2VzcycsIGZ1bmN0aW9uKGRvbmUpIHtcbiAgICBjb25zdCBvcHRpb25zID0ge1xuICAgICAgbWV0aG9kOiAnUE9TVCcsXG4gICAgICB1cmw6ICcvbG9naW4nLFxuICAgICAgaGVhZGVyczoge1xuICAgICAgICAnQXV0aG9yaXphdGlvbic6IGBCZWFyZXIgJHtkYXRhLmZwLnRva2VuLnZhbHVlfWBcbiAgICAgIH0sXG4gICAgICBwYXlsb2FkOiB7XG4gICAgICAgIHVzZXJuYW1lOiBkYXRhLnRwLmFjY291bnQudXNlcm5hbWUsXG4gICAgICAgIHBhc3N3b3JkOiBkYXRhLnRwLmFjY291bnQudW5lbmNyeXB0ZWRQYXNzd29yZFxuICAgICAgfVxuICAgIH07XG5cbiAgICBzZXJ2ZXIuaW5qZWN0KG9wdGlvbnMsIGZ1bmN0aW9uKHJlc3BvbnNlKSB7XG4gICAgICBjb25zdCByZXN1bHQgPSByZXNwb25zZS5yZXN1bHQ7XG5cbiAgICAgIGV4cGVjdChyZXNwb25zZS5zdGF0dXNDb2RlKS50by5lcXVhbCgyMDApO1xuICAgICAgZXhwZWN0KHJlc3VsdC51c2VybmFtZSkudG8uZXF1YWwoZGF0YS50cC5hY2NvdW50LnVzZXJuYW1lKTtcbiAgICAgIGV4cGVjdChyZXN1bHQucHJvZmlsZSkudG8ubm90LmJlLnVuZGVmaW5lZCgpO1xuXG4gICAgICBkb25lKCk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGxhYi50ZXN0KCdbbG9nSW5dIHJldHVybnMgNDA0IGZvciBpbnZhbGlkIHVzZXJuYW1lJywgZnVuY3Rpb24oZG9uZSkge1xuICAgIGNvbnN0IG9wdGlvbnMgPSB7XG4gICAgICBtZXRob2Q6ICdQT1NUJyxcbiAgICAgIHVybDogJy9sb2dpbicsXG4gICAgICBoZWFkZXJzOiB7XG4gICAgICAgICdBdXRob3JpemF0aW9uJzogYEJlYXJlciAke2RhdGEuZnAudG9rZW4udmFsdWV9YFxuICAgICAgfSxcbiAgICAgIHBheWxvYWQ6IHtcbiAgICAgICAgdXNlcm5hbWU6ICcxMzM3NDQnLFxuICAgICAgICBwYXNzd29yZDogZGF0YS50cC5hY2NvdW50LnVuZW5jcnlwdGVkUGFzc3dvcmRcbiAgICAgIH1cbiAgICB9O1xuXG4gICAgc2VydmVyLmluamVjdChvcHRpb25zLCBmdW5jdGlvbihyZXNwb25zZSkge1xuICAgICAgZXhwZWN0KHJlc3BvbnNlLnN0YXR1c0NvZGUpLnRvLmVxdWFsKDQwNCk7XG4gICAgICBkb25lKCk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGxhYi50ZXN0KCdbbG9nSW5dIHJldHVybnMgNDAxIGZvciBpbnZhbGlkIHBhc3N3b3JkJywgZnVuY3Rpb24oZG9uZSkge1xuICAgIGNvbnN0IG9wdGlvbnMgPSB7XG4gICAgICBtZXRob2Q6ICdQT1NUJyxcbiAgICAgIHVybDogJy9sb2dpbicsXG4gICAgICBoZWFkZXJzOiB7XG4gICAgICAgICdBdXRob3JpemF0aW9uJzogYEJlYXJlciAke2RhdGEuZnAudG9rZW4udmFsdWV9YFxuICAgICAgfSxcbiAgICAgIHBheWxvYWQ6IHtcbiAgICAgICAgdXNlcm5hbWU6IGRhdGEudHAuYWNjb3VudC51c2VybmFtZSxcbiAgICAgICAgcGFzc3dvcmQ6ICcxMzM3NDQnXG4gICAgICB9XG4gICAgfTtcblxuICAgIHNlcnZlci5pbmplY3Qob3B0aW9ucywgZnVuY3Rpb24ocmVzcG9uc2UpIHtcbiAgICAgIGV4cGVjdChyZXNwb25zZS5zdGF0dXNDb2RlKS50by5lcXVhbCg0MDEpO1xuICAgICAgZG9uZSgpO1xuICAgIH0pO1xuICB9KTtcblxuICBsYWIudGVzdCgnW2F1dGhvcml6ZV0gcmV0dXJucyBhbiBvYXV0aCBjb2RlIGZvciBleGNoYW5nZScsIGZ1bmN0aW9uKGRvbmUpIHtcbiAgICBjb25zdCBvcHRpb25zID0ge1xuICAgICAgbWV0aG9kOiAnUE9TVCcsXG4gICAgICB1cmw6ICcvb2F1dGgvYXV0aG9yaXplJyxcbiAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgJ0F1dGhvcml6YXRpb24nOiBgQmVhcmVyICR7ZGF0YS5mcC50b2tlbi52YWx1ZX1gXG4gICAgICB9LFxuICAgICAgcGF5bG9hZDoge1xuICAgICAgICBzY29wZTogb2F1dGhTY29wZSxcbiAgICAgICAgY2xpZW50SWQ6IGRhdGEudHAuY2xpZW50LmlkXG4gICAgICB9XG4gICAgfTtcblxuICAgIHNlcnZlci5pbmplY3Qob3B0aW9ucywgZnVuY3Rpb24ocmVzcG9uc2UpIHtcbiAgICAgIGNvbnN0IHJlc3VsdCA9IHJlc3BvbnNlLnJlc3VsdDtcbiAgICAgIG9hdXRoQ29kZSA9IHJlc3VsdC52YWx1ZTtcblxuICAgICAgZXhwZWN0KHJlc3BvbnNlLnN0YXR1c0NvZGUpLnRvLmVxdWFsKDIwMCk7XG4gICAgICBleHBlY3QocmVzdWx0LmNsaWVudElkKS50by5lcXVhbChkYXRhLnRwLmNsaWVudC5pZCk7XG4gICAgICBleHBlY3QocmVzdWx0LnZhbHVlKS50by5leGlzdCgpO1xuXG4gICAgICBkb25lKCk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGxhYi50ZXN0KCdbZXhjaGFuZ2VDb2RlXSByZXR1cm5zIGFuIGVycm9yIGlmIHRoZSBzZWNyZXQgaXMgaW52YWxpZCcsIGZ1bmN0aW9uKGRvbmUpIHtcbiAgICBjb25zdCBvcHRpb25zID0ge1xuICAgICAgbWV0aG9kOiAnUE9TVCcsXG4gICAgICB1cmw6ICcvb2F1dGgvZXhjaGFuZ2UvY29kZScsXG4gICAgICBoZWFkZXJzOiB7XG4gICAgICAgICdBdXRob3JpemF0aW9uJzogYEJlYXJlciAke2RhdGEuZnAudG9rZW4udmFsdWV9YFxuICAgICAgfSxcbiAgICAgIHBheWxvYWQ6IHtcbiAgICAgICAgY29kZTogb2F1dGhDb2RlLFxuICAgICAgICBjbGllbnRJZDogZGF0YS50cC5jbGllbnQuaWQsXG4gICAgICAgIGNsaWVudFNlY3JldDogJ0l0c05vdEFTZWNyZXRJZllvdVRvbGRFdmVyeWJvZHknXG4gICAgICB9XG4gICAgfTtcblxuICAgIHNlcnZlci5pbmplY3Qob3B0aW9ucywgZnVuY3Rpb24ocmVzcG9uc2UpIHtcbiAgICAgIGV4cGVjdChyZXNwb25zZS5zdGF0dXNDb2RlKS50by5lcXVhbCg0MDApO1xuICAgICAgZG9uZSgpO1xuICAgIH0pO1xuICB9KTtcblxuICBsYWIudGVzdCgnW2V4Y2hhbmdlQ29kZV0gcmV0dXJucyBhIGJlYXJlciB0b2tlbiBpZiB0aGUgY29kZSBpcyB2YWxpZCcsIGZ1bmN0aW9uKGRvbmUpIHtcbiAgICBjb25zdCBvcHRpb25zID0ge1xuICAgICAgbWV0aG9kOiAnUE9TVCcsXG4gICAgICB1cmw6ICcvb2F1dGgvZXhjaGFuZ2UvY29kZScsXG4gICAgICBoZWFkZXJzOiB7XG4gICAgICAgICdBdXRob3JpemF0aW9uJzogYEJlYXJlciAke2RhdGEuZnAudG9rZW4udmFsdWV9YFxuICAgICAgfSxcbiAgICAgIHBheWxvYWQ6IHtcbiAgICAgICAgY29kZTogb2F1dGhDb2RlLFxuICAgICAgICBjbGllbnRJZDogZGF0YS50cC5jbGllbnQuaWQsXG4gICAgICAgIGNsaWVudFNlY3JldDogZGF0YS50cC5jbGllbnQuc2VjcmV0XG4gICAgICB9XG4gICAgfTtcblxuICAgIHNlcnZlci5pbmplY3Qob3B0aW9ucywgZnVuY3Rpb24ocmVzcG9uc2UpIHtcbiAgICAgIGNvbnN0IHJlc3VsdCA9IHJlc3BvbnNlLnJlc3VsdDtcblxuICAgICAgZXhwZWN0KHJlc3BvbnNlLnN0YXR1c0NvZGUpLnRvLmVxdWFsKDIwMCk7XG4gICAgICBleHBlY3QocmVzdWx0LnNjb3BlKS50by5lcXVhbChvYXV0aFNjb3BlKTtcbiAgICAgIGV4cGVjdChyZXN1bHQudmFsdWUpLnRvLmV4aXN0KCk7XG5cbiAgICAgIGRvbmUoKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgbGFiLnRlc3QoJ1tleGNoYW5nZUNvZGVdIHJldHVybnMgYW4gZXJyb3IgaWYgdGhlIGNvZGUgaXMgaW52YWxpZCcsIGZ1bmN0aW9uKGRvbmUpIHtcbiAgICBjb25zdCBvcHRpb25zID0ge1xuICAgICAgbWV0aG9kOiAnUE9TVCcsXG4gICAgICB1cmw6ICcvb2F1dGgvZXhjaGFuZ2UvY29kZScsXG4gICAgICBoZWFkZXJzOiB7XG4gICAgICAgICdBdXRob3JpemF0aW9uJzogYEJlYXJlciAke2RhdGEuZnAudG9rZW4udmFsdWV9YFxuICAgICAgfSxcbiAgICAgIHBheWxvYWQ6IHtcbiAgICAgICAgY29kZTogJzEwMjQwJyxcbiAgICAgICAgY2xpZW50SWQ6IGRhdGEudHAuY2xpZW50LmlkLFxuICAgICAgICBjbGllbnRTZWNyZXQ6IGRhdGEudHAuY2xpZW50LnNlY3JldFxuICAgICAgfVxuICAgIH07XG5cbiAgICBzZXJ2ZXIuaW5qZWN0KG9wdGlvbnMsIGZ1bmN0aW9uKHJlc3BvbnNlKSB7XG4gICAgICBleHBlY3QocmVzcG9uc2Uuc3RhdHVzQ29kZSkudG8uZXF1YWwoNDA0KTtcbiAgICAgIGRvbmUoKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgbGFiLnRlc3QoJ1tleGNoYW5nZUNvZGVdIHJldHVybnMgYW4gZXJyb3IgaWYgdGhlIGNvZGUgaGFzIGFscmVhZHkgYmVlbiB1c2VkJywgZnVuY3Rpb24oZG9uZSkge1xuICAgIGNvbnN0IG9wdGlvbnMgPSB7XG4gICAgICBtZXRob2Q6ICdQT1NUJyxcbiAgICAgIHVybDogJy9vYXV0aC9leGNoYW5nZS9jb2RlJyxcbiAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgJ0F1dGhvcml6YXRpb24nOiBgQmVhcmVyICR7ZGF0YS5mcC50b2tlbi52YWx1ZX1gXG4gICAgICB9LFxuICAgICAgcGF5bG9hZDoge1xuICAgICAgICBjb2RlOiBvYXV0aENvZGUsXG4gICAgICAgIGNsaWVudElkOiBkYXRhLnRwLmNsaWVudC5pZCxcbiAgICAgICAgY2xpZW50U2VjcmV0OiBkYXRhLnRwLmNsaWVudC5zZWNyZXRcbiAgICAgIH1cbiAgICB9O1xuXG4gICAgc2VydmVyLmluamVjdChvcHRpb25zLCBmdW5jdGlvbihyZXNwb25zZSkge1xuICAgICAgZXhwZWN0KHJlc3BvbnNlLnN0YXR1c0NvZGUpLnRvLmVxdWFsKDQwMCk7XG4gICAgICBkb25lKCk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGxhYi50ZXN0KCdbZXhjaGFuZ2VDcmVkZW50aWFsc10gcmV0dXJucyBhIGJlYXJlciB0b2tlbiBmb3IgdmFsaWQgY3JlZGVudGlhbHMnLCBmdW5jdGlvbihkb25lKSB7XG4gICAgY29uc3Qgb3B0aW9ucyA9IHtcbiAgICAgIG1ldGhvZDogJ1BPU1QnLFxuICAgICAgdXJsOiAnL29hdXRoL2V4Y2hhbmdlL2NyZWRlbnRpYWxzJyxcbiAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgJ0F1dGhvcml6YXRpb24nOiBgQmVhcmVyICR7ZGF0YS5mcC50b2tlbi52YWx1ZX1gXG4gICAgICB9LFxuICAgICAgcGF5bG9hZDoge1xuICAgICAgICB1c2VybmFtZTogZGF0YS50cC5hY2NvdW50LnVzZXJuYW1lLFxuICAgICAgICBwYXNzd29yZDogZGF0YS50cC5hY2NvdW50LnVuZW5jcnlwdGVkUGFzc3dvcmRcbiAgICAgIH1cbiAgICB9O1xuXG4gICAgc2VydmVyLmluamVjdChvcHRpb25zLCBmdW5jdGlvbihyZXNwb25zZSkge1xuICAgICAgY29uc3QgcmVzdWx0ID0gcmVzcG9uc2UucmVzdWx0O1xuXG4gICAgICBleHBlY3QocmVzcG9uc2Uuc3RhdHVzQ29kZSkudG8uZXF1YWwoMjAwKTtcbiAgICAgIGV4cGVjdChyZXN1bHQudmFsdWUpLnRvLmV4aXN0KCk7XG5cbiAgICAgIGRvbmUoKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgbGFiLnRlc3QoJ1tleGNoYW5nZUNyZWRlbnRpYWxzXSByZXR1cm5zIDQwMSBmb3IgaW52YWxpZCBwYXNzd29yZCcsIGZ1bmN0aW9uKGRvbmUpIHtcbiAgICBjb25zdCBvcHRpb25zID0ge1xuICAgICAgbWV0aG9kOiAnUE9TVCcsXG4gICAgICB1cmw6ICcvb2F1dGgvZXhjaGFuZ2UvY3JlZGVudGlhbHMnLFxuICAgICAgaGVhZGVyczoge1xuICAgICAgICAnQXV0aG9yaXphdGlvbic6IGBCZWFyZXIgJHtkYXRhLmZwLnRva2VuLnZhbHVlfWBcbiAgICAgIH0sXG4gICAgICBwYXlsb2FkOiB7XG4gICAgICAgIHVzZXJuYW1lOiBkYXRhLnRwLmFjY291bnQudXNlcm5hbWUsXG4gICAgICAgIHBhc3N3b3JkOiAnMTMzNydcbiAgICAgIH1cbiAgICB9O1xuXG4gICAgc2VydmVyLmluamVjdChvcHRpb25zLCBmdW5jdGlvbihyZXNwb25zZSkge1xuICAgICAgZXhwZWN0KHJlc3BvbnNlLnN0YXR1c0NvZGUpLnRvLmVxdWFsKDQwMSk7XG4gICAgICBkb25lKCk7XG4gICAgfSk7XG4gIH0pO1xuXG59KTtcbiJdfQ==