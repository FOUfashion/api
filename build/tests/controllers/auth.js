'use strict';

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _lab = require('lab');

var _lab2 = _interopRequireDefault(_lab);

var _server = require('../../server');

var _server2 = _interopRequireDefault(_server);

var _faker = require('faker');

var _faker2 = _interopRequireDefault(_faker);

var _data = require('../data');

var _data2 = _interopRequireDefault(_data);

var expect = _lab2['default'].assertions.expect;
var lab = _lab2['default'].script();

exports.lab = lab;
lab.experiment('AuthCtrl', function () {

  var oauthScope = 'test';
  var oauthCode = null;

  lab.before(function (done) {
    _data2['default'].sync().then(done, done);
  });

  lab.test('[authorize] returns an oauth code for exchange', function (done) {
    var options = {
      method: 'POST',
      url: '/oauth/authorize',
      headers: {
        'Authorization': 'Bearer ' + _data2['default'].fp.token.value
      },
      payload: {
        scope: oauthScope,
        clientId: _data2['default'].client.id
      }
    };

    _server2['default'].inject(options, function (response) {
      var result = response.result;
      oauthCode = result.value;

      expect(response.statusCode).to.equal(200);
      expect(result.clientId).to.equal(_data2['default'].client.id);
      expect(result.value).to.exist();

      done();
    });
  });

  lab.test('[exchangeCode] returns an error if the secret is invalid', function (done) {
    var options = {
      method: 'POST',
      url: '/oauth/exchange/code',
      headers: {
        'Authorization': 'Bearer ' + _data2['default'].fp.token.value
      },
      payload: {
        code: oauthCode,
        clientId: _data2['default'].client.id,
        clientSecret: 'ItsNotASecretIfYouToldEverybody'
      }
    };

    _server2['default'].inject(options, function (response) {
      expect(response.statusCode).to.equal(400);
      done();
    });
  });

  lab.test('[exchangeCode] returns a bearer token if the code is valid', function (done) {
    var options = {
      method: 'POST',
      url: '/oauth/exchange/code',
      headers: {
        'Authorization': 'Bearer ' + _data2['default'].fp.token.value
      },
      payload: {
        code: oauthCode,
        clientId: _data2['default'].client.id,
        clientSecret: _data2['default'].client.secret
      }
    };

    _server2['default'].inject(options, function (response) {
      var result = response.result;

      expect(response.statusCode).to.equal(200);
      expect(result.scope).to.equal(oauthScope);
      expect(result.value).to.exist();

      done();
    });
  });

  lab.test('[exchangeCode] returns an error if the code is invalid', function (done) {
    var options = {
      method: 'POST',
      url: '/oauth/exchange/code',
      headers: {
        'Authorization': 'Bearer ' + _data2['default'].fp.token.value
      },
      payload: {
        code: '10240',
        clientId: _data2['default'].client.id,
        clientSecret: _data2['default'].client.secret
      }
    };

    _server2['default'].inject(options, function (response) {
      expect(response.statusCode).to.equal(404);
      done();
    });
  });

  lab.test('[exchangeCode] returns an error if the code has already been used', function (done) {
    var options = {
      method: 'POST',
      url: '/oauth/exchange/code',
      headers: {
        'Authorization': 'Bearer ' + _data2['default'].fp.token.value
      },
      payload: {
        code: oauthCode,
        clientId: _data2['default'].client.id,
        clientSecret: _data2['default'].client.secret
      }
    };

    _server2['default'].inject(options, function (response) {
      expect(response.statusCode).to.equal(400);
      done();
    });
  });

  lab.test('[exchangeCredentials] returns a bearer token for valid credentials', function (done) {
    var options = {
      method: 'POST',
      url: '/oauth/exchange/credentials',
      headers: {
        'Authorization': 'Bearer ' + _data2['default'].fp.token.value
      },
      payload: {
        username: _data2['default'].account.username,
        password: _data2['default'].account.unencryptedPassword
      }
    };

    _server2['default'].inject(options, function (response) {
      var result = response.result;

      expect(response.statusCode).to.equal(200);
      expect(result.value).to.exist();

      done();
    });
  });

  lab.test('[exchangeCredentials] returns 401 for invalid password', function (done) {
    var options = {
      method: 'POST',
      url: '/oauth/exchange/credentials',
      headers: {
        'Authorization': 'Bearer ' + _data2['default'].fp.token.value
      },
      payload: {
        username: _data2['default'].account.username,
        password: '1337'
      }
    };

    _server2['default'].inject(options, function (response) {
      expect(response.statusCode).to.equal(401);
      done();
    });
  });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy90ZXN0cy9jb250cm9sbGVycy9hdXRoLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7O21CQUFnQixLQUFLOzs7O3NCQUNGLGNBQWM7Ozs7cUJBRWYsT0FBTzs7OztvQkFDUixTQUFTOzs7O0FBRTFCLElBQU0sTUFBTSxHQUFHLGlCQUFJLFVBQVUsQ0FBQyxNQUFNLENBQUM7QUFDOUIsSUFBTSxHQUFHLEdBQUcsaUJBQUksTUFBTSxFQUFFLENBQUM7O1FBQW5CLEdBQUcsR0FBSCxHQUFHO0FBRWhCLEdBQUcsQ0FBQyxVQUFVLENBQUMsVUFBVSxFQUFFLFlBQVc7O0FBRXBDLE1BQUksVUFBVSxHQUFHLE1BQU0sQ0FBQztBQUN4QixNQUFJLFNBQVMsR0FBRyxJQUFJLENBQUM7O0FBRXJCLEtBQUcsQ0FBQyxNQUFNLENBQUMsVUFBQSxJQUFJLEVBQUk7QUFDakIsc0JBQUssSUFBSSxFQUFFLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsQ0FBQztHQUM5QixDQUFDLENBQUM7O0FBRUgsS0FBRyxDQUFDLElBQUksQ0FBQyxnREFBZ0QsRUFBRSxVQUFTLElBQUksRUFBRTtBQUN4RSxRQUFNLE9BQU8sR0FBRztBQUNkLFlBQU0sRUFBRSxNQUFNO0FBQ2QsU0FBRyxFQUFFLGtCQUFrQjtBQUN2QixhQUFPLEVBQUU7QUFDUCx1QkFBZSxjQUFZLGtCQUFLLEVBQUUsQ0FBQyxLQUFLLENBQUMsS0FBSyxBQUFFO09BQ2pEO0FBQ0QsYUFBTyxFQUFFO0FBQ1AsYUFBSyxFQUFFLFVBQVU7QUFDakIsZ0JBQVEsRUFBRSxrQkFBSyxNQUFNLENBQUMsRUFBRTtPQUN6QjtLQUNGLENBQUM7O0FBRUYsd0JBQU8sTUFBTSxDQUFDLE9BQU8sRUFBRSxVQUFTLFFBQVEsRUFBRTtBQUN4QyxVQUFNLE1BQU0sR0FBRyxRQUFRLENBQUMsTUFBTSxDQUFDO0FBQy9CLGVBQVMsR0FBRyxNQUFNLENBQUMsS0FBSyxDQUFDOztBQUV6QixZ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Q0YsQ0FBQzs7QUFFRix3QkFBTyxNQUFNLENBQUMsT0FBTyxFQUFFLFVBQVMsUUFBUSxFQUFFO0FBQ3hDLFVBQU0sTUFBTSxHQUFHLFFBQVEsQ0FBQyxNQUFNLENBQUM7O0FBRS9CLFlBQU0sQ0FBQyxRQUFRLENBQUMsVUFBVSxDQUFDLENBQUMsRUFBRSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztBQUMxQyxZQUFNLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUUsQ0FBQyxLQUFLLEVBQUUsQ0FBQzs7QUFFaEMsVUFBSSxFQUFFLENBQUM7S0FDUixDQUFDLENBQUM7R0FDSixDQUFDLENBQUM7O0FBRUgsS0FBRyxDQUFDLElBQUksQ0FBQyx3REFBd0QsRUFBRSxVQUFTLElBQUksRUFBRTtBQUNoRixRQUFNLE9BQU8sR0FBRztBQUNkLFlBQU0sRUFBRSxNQUFNO0FBQ2QsU0FBRyxFQUFFLDZCQUE2QjtBQUNsQyxhQUFPLEVBQUU7QUFDUCx1QkFBZSxjQUFZLGtCQUFLLEVBQUUsQ0FBQyxLQUFLLENBQUMsS0FBSyxBQUFFO09BQ2pEO0FBQ0QsYUFBTyxFQUFFO0FBQ1AsZ0JBQVEsRUFBRSxrQkFBSyxPQUFPLENBQUMsUUFBUTtBQUMvQixnQkFBUSxFQUFFLE1BQU07T0FDakI7S0FDRixDQUFDOztBQUVGLHdCQUFPLE1BQU0sQ0FBQyxPQUFPLEVBQUUsVUFBUyxRQUFRLEVBQUU7QUFDeEMsWUFBTSxDQUFDLFFBQVEsQ0FBQyxVQUFVLENBQUMsQ0FBQyxFQUFFLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO0FBQzFDLFVBQUksRUFBRSxDQUFDO0tBQ1IsQ0FBQyxDQUFDO0dBQ0osQ0FBQyxDQUFDO0NBRUosQ0FBQyxDQUFDIiwiZmlsZSI6ImF1dGguanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgTGFiIGZyb20gJ2xhYic7XG5pbXBvcnQgc2VydmVyIGZyb20gJy4uLy4uL3NlcnZlcic7XG5cbmltcG9ydCBmYWtlciBmcm9tICdmYWtlcic7XG5pbXBvcnQgZGF0YSBmcm9tICcuLi9kYXRhJztcblxuY29uc3QgZXhwZWN0ID0gTGFiLmFzc2VydGlvbnMuZXhwZWN0O1xuZXhwb3J0IGNvbnN0IGxhYiA9IExhYi5zY3JpcHQoKTtcblxubGFiLmV4cGVyaW1lbnQoJ0F1dGhDdHJsJywgZnVuY3Rpb24oKSB7XG5cbiAgbGV0IG9hdXRoU2NvcGUgPSAndGVzdCc7XG4gIGxldCBvYXV0aENvZGUgPSBudWxsO1xuXG4gIGxhYi5iZWZvcmUoZG9uZSA9PiB7XG4gICAgZGF0YS5zeW5jKCkudGhlbihkb25lLCBkb25lKTtcbiAgfSk7XG5cbiAgbGFiLnRlc3QoJ1thdXRob3JpemVdIHJldHVybnMgYW4gb2F1dGggY29kZSBmb3IgZXhjaGFuZ2UnLCBmdW5jdGlvbihkb25lKSB7XG4gICAgY29uc3Qgb3B0aW9ucyA9IHtcbiAgICAgIG1ldGhvZDogJ1BPU1QnLFxuICAgICAgdXJsOiAnL29hdXRoL2F1dGhvcml6ZScsXG4gICAgICBoZWFkZXJzOiB7XG4gICAgICAgICdBdXRob3JpemF0aW9uJzogYEJlYXJlciAke2RhdGEuZnAudG9rZW4udmFsdWV9YFxuICAgICAgfSxcbiAgICAgIHBheWxvYWQ6IHtcbiAgICAgICAgc2NvcGU6IG9hdXRoU2NvcGUsXG4gICAgICAgIGNsaWVudElkOiBkYXRhLmNsaWVudC5pZFxuICAgICAgfVxuICAgIH07XG5cbiAgICBzZXJ2ZXIuaW5qZWN0KG9wdGlvbnMsIGZ1bmN0aW9uKHJlc3BvbnNlKSB7XG4gICAgICBjb25zdCByZXN1bHQgPSByZXNwb25zZS5yZXN1bHQ7XG4gICAgICBvYXV0aENvZGUgPSByZXN1bHQudmFsdWU7XG5cbiAgICAgIGV4cGVjdChyZXNwb25zZS5zdGF0dXNDb2RlKS50by5lcXVhbCgyMDApO1xuICAgICAgZXhwZWN0KHJlc3VsdC5jbGllbnRJZCkudG8uZXF1YWwoZGF0YS5jbGllbnQuaWQpO1xuICAgICAgZXhwZWN0KHJlc3VsdC52YWx1ZSkudG8uZXhpc3QoKTtcblxuICAgICAgZG9uZSgpO1xuICAgIH0pO1xuICB9KTtcblxuICBsYWIudGVzdCgnW2V4Y2hhbmdlQ29kZV0gcmV0dXJucyBhbiBlcnJvciBpZiB0aGUgc2VjcmV0IGlzIGludmFsaWQnLCBmdW5jdGlvbihkb25lKSB7XG4gICAgY29uc3Qgb3B0aW9ucyA9IHtcbiAgICAgIG1ldGhvZDogJ1BPU1QnLFxuICAgICAgdXJsOiAnL29hdXRoL2V4Y2hhbmdlL2NvZGUnLFxuICAgICAgaGVhZGVyczoge1xuICAgICAgICAnQXV0aG9yaXphdGlvbic6IGBCZWFyZXIgJHtkYXRhLmZwLnRva2VuLnZhbHVlfWBcbiAgICAgIH0sXG4gICAgICBwYXlsb2FkOiB7XG4gICAgICAgIGNvZGU6IG9hdXRoQ29kZSxcbiAgICAgICAgY2xpZW50SWQ6IGRhdGEuY2xpZW50LmlkLFxuICAgICAgICBjbGllbnRTZWNyZXQ6ICdJdHNOb3RBU2VjcmV0SWZZb3VUb2xkRXZlcnlib2R5J1xuICAgICAgfVxuICAgIH07XG5cbiAgICBzZXJ2ZXIuaW5qZWN0KG9wdGlvbnMsIGZ1bmN0aW9uKHJlc3BvbnNlKSB7XG4gICAgICBleHBlY3QocmVzcG9uc2Uuc3RhdHVzQ29kZSkudG8uZXF1YWwoNDAwKTtcbiAgICAgIGRvbmUoKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgbGFiLnRlc3QoJ1tleGNoYW5nZUNvZGVdIHJldHVybnMgYSBiZWFyZXIgdG9rZW4gaWYgdGhlIGNvZGUgaXMgdmFsaWQnLCBmdW5jdGlvbihkb25lKSB7XG4gICAgY29uc3Qgb3B0aW9ucyA9IHtcbiAgICAgIG1ldGhvZDogJ1BPU1QnLFxuICAgICAgdXJsOiAnL29hdXRoL2V4Y2hhbmdlL2NvZGUnLFxuICAgICAgaGVhZGVyczoge1xuICAgICAgICAnQXV0aG9yaXphdGlvbic6IGBCZWFyZXIgJHtkYXRhLmZwLnRva2VuLnZhbHVlfWBcbiAgICAgIH0sXG4gICAgICBwYXlsb2FkOiB7XG4gICAgICAgIGNvZGU6IG9hdXRoQ29kZSxcbiAgICAgICAgY2xpZW50SWQ6IGRhdGEuY2xpZW50LmlkLFxuICAgICAgICBjbGllbnRTZWNyZXQ6IGRhdGEuY2xpZW50LnNlY3JldFxuICAgICAgfVxuICAgIH07XG5cbiAgICBzZXJ2ZXIuaW5qZWN0KG9wdGlvbnMsIGZ1bmN0aW9uKHJlc3BvbnNlKSB7XG4gICAgICBjb25zdCByZXN1bHQgPSByZXNwb25zZS5yZXN1bHQ7XG5cbiAgICAgIGV4cGVjdChyZXNwb25zZS5zdGF0dXNDb2RlKS50by5lcXVhbCgyMDApO1xuICAgICAgZXhwZWN0KHJlc3VsdC5zY29wZSkudG8uZXF1YWwob2F1dGhTY29wZSk7XG4gICAgICBleHBlY3QocmVzdWx0LnZhbHVlKS50by5leGlzdCgpO1xuXG4gICAgICBkb25lKCk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGxhYi50ZXN0KCdbZXhjaGFuZ2VDb2RlXSByZXR1cm5zIGFuIGVycm9yIGlmIHRoZSBjb2RlIGlzIGludmFsaWQnLCBmdW5jdGlvbihkb25lKSB7XG4gICAgY29uc3Qgb3B0aW9ucyA9IHtcbiAgICAgIG1ldGhvZDogJ1BPU1QnLFxuICAgICAgdXJsOiAnL29hdXRoL2V4Y2hhbmdlL2NvZGUnLFxuICAgICAgaGVhZGVyczoge1xuICAgICAgICAnQXV0aG9yaXphdGlvbic6IGBCZWFyZXIgJHtkYXRhLmZwLnRva2VuLnZhbHVlfWBcbiAgICAgIH0sXG4gICAgICBwYXlsb2FkOiB7XG4gICAgICAgIGNvZGU6ICcxMDI0MCcsXG4gICAgICAgIGNsaWVudElkOiBkYXRhLmNsaWVudC5pZCxcbiAgICAgICAgY2xpZW50U2VjcmV0OiBkYXRhLmNsaWVudC5zZWNyZXRcbiAgICAgIH1cbiAgICB9O1xuXG4gICAgc2VydmVyLmluamVjdChvcHRpb25zLCBmdW5jdGlvbihyZXNwb25zZSkge1xuICAgICAgZXhwZWN0KHJlc3BvbnNlLnN0YXR1c0NvZGUpLnRvLmVxdWFsKDQwNCk7XG4gICAgICBkb25lKCk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGxhYi50ZXN0KCdbZXhjaGFuZ2VDb2RlXSByZXR1cm5zIGFuIGVycm9yIGlmIHRoZSBjb2RlIGhhcyBhbHJlYWR5IGJlZW4gdXNlZCcsIGZ1bmN0aW9uKGRvbmUpIHtcbiAgICBjb25zdCBvcHRpb25zID0ge1xuICAgICAgbWV0aG9kOiAnUE9TVCcsXG4gICAgICB1cmw6ICcvb2F1dGgvZXhjaGFuZ2UvY29kZScsXG4gICAgICBoZWFkZXJzOiB7XG4gICAgICAgICdBdXRob3JpemF0aW9uJzogYEJlYXJlciAke2RhdGEuZnAudG9rZW4udmFsdWV9YFxuICAgICAgfSxcbiAgICAgIHBheWxvYWQ6IHtcbiAgICAgICAgY29kZTogb2F1dGhDb2RlLFxuICAgICAgICBjbGllbnRJZDogZGF0YS5jbGllbnQuaWQsXG4gICAgICAgIGNsaWVudFNlY3JldDogZGF0YS5jbGllbnQuc2VjcmV0XG4gICAgICB9XG4gICAgfTtcblxuICAgIHNlcnZlci5pbmplY3Qob3B0aW9ucywgZnVuY3Rpb24ocmVzcG9uc2UpIHtcbiAgICAgIGV4cGVjdChyZXNwb25zZS5zdGF0dXNDb2RlKS50by5lcXVhbCg0MDApO1xuICAgICAgZG9uZSgpO1xuICAgIH0pO1xuICB9KTtcblxuICBsYWIudGVzdCgnW2V4Y2hhbmdlQ3JlZGVudGlhbHNdIHJldHVybnMgYSBiZWFyZXIgdG9rZW4gZm9yIHZhbGlkIGNyZWRlbnRpYWxzJywgZnVuY3Rpb24oZG9uZSkge1xuICAgIGNvbnN0IG9wdGlvbnMgPSB7XG4gICAgICBtZXRob2Q6ICdQT1NUJyxcbiAgICAgIHVybDogJy9vYXV0aC9leGNoYW5nZS9jcmVkZW50aWFscycsXG4gICAgICBoZWFkZXJzOiB7XG4gICAgICAgICdBdXRob3JpemF0aW9uJzogYEJlYXJlciAke2RhdGEuZnAudG9rZW4udmFsdWV9YFxuICAgICAgfSxcbiAgICAgIHBheWxvYWQ6IHtcbiAgICAgICAgdXNlcm5hbWU6IGRhdGEuYWNjb3VudC51c2VybmFtZSxcbiAgICAgICAgcGFzc3dvcmQ6IGRhdGEuYWNjb3VudC51bmVuY3J5cHRlZFBhc3N3b3JkXG4gICAgICB9XG4gICAgfTtcblxuICAgIHNlcnZlci5pbmplY3Qob3B0aW9ucywgZnVuY3Rpb24ocmVzcG9uc2UpIHtcbiAgICAgIGNvbnN0IHJlc3VsdCA9IHJlc3BvbnNlLnJlc3VsdDtcblxuICAgICAgZXhwZWN0KHJlc3BvbnNlLnN0YXR1c0NvZGUpLnRvLmVxdWFsKDIwMCk7XG4gICAgICBleHBlY3QocmVzdWx0LnZhbHVlKS50by5leGlzdCgpO1xuXG4gICAgICBkb25lKCk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGxhYi50ZXN0KCdbZXhjaGFuZ2VDcmVkZW50aWFsc10gcmV0dXJucyA0MDEgZm9yIGludmFsaWQgcGFzc3dvcmQnLCBmdW5jdGlvbihkb25lKSB7XG4gICAgY29uc3Qgb3B0aW9ucyA9IHtcbiAgICAgIG1ldGhvZDogJ1BPU1QnLFxuICAgICAgdXJsOiAnL29hdXRoL2V4Y2hhbmdlL2NyZWRlbnRpYWxzJyxcbiAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgJ0F1dGhvcml6YXRpb24nOiBgQmVhcmVyICR7ZGF0YS5mcC50b2tlbi52YWx1ZX1gXG4gICAgICB9LFxuICAgICAgcGF5bG9hZDoge1xuICAgICAgICB1c2VybmFtZTogZGF0YS5hY2NvdW50LnVzZXJuYW1lLFxuICAgICAgICBwYXNzd29yZDogJzEzMzcnXG4gICAgICB9XG4gICAgfTtcblxuICAgIHNlcnZlci5pbmplY3Qob3B0aW9ucywgZnVuY3Rpb24ocmVzcG9uc2UpIHtcbiAgICAgIGV4cGVjdChyZXNwb25zZS5zdGF0dXNDb2RlKS50by5lcXVhbCg0MDEpO1xuICAgICAgZG9uZSgpO1xuICAgIH0pO1xuICB9KTtcblxufSk7XG4iXX0=